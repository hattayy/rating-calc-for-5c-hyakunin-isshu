# 百人一首レーティングシステム

百人一首の対戦結果から各プレイヤーのレーティングを計算するPythonアプリケーションです。

## 機能

- Excelファイルから試合結果データを読み込み
- 獲得札数を考慮したレーティング計算システム
- 試合ごとのレーティング更新
- 結果のExcelファイル出力

## 必要な環境

- Python 3.8以上
- pandas
- openpyxl
- numpy

## インストール

```bash
pip install -r requirements.txt
```

## 使用方法

### 基本的な使用方法

```bash
python main.py input_data.xlsx
```

### オプション

```bash
python main.py input_data.xlsx -o output_results.xlsx -k 32 -i 1500 -w 0.3
```

- `-o, --output`: 出力ファイル名（デフォルト: rating_results.xlsx）
- `-s, --sheet`: 読み込むシート名（指定しない場合は最初のシート）
- `-k, --k_factor`: K値（レーティング変動の大きさ、デフォルト: 32）
- `-i, --initial_rating`: 初期レーティング（デフォルト: 1500）
- `-w, --card_weight`: 獲得札数の重み 0.0-1.0（デフォルト: 0.3）

## 入力データ形式

Excelファイルには以下の列が必要です：

| 列名 | 説明 | 例 |
|------|------|-----|
| 試合番号 | 試合の番号 | 1, 2, 3... |
| 名前 | プレイヤー名 | 田中太郎 |
| 相手 | 対戦相手名 | 佐藤花子 |
| 結果 | 試合結果 | 勝 / 負 |
| 獲得札数 | 取った札の枚数 | 12 |

### データの注意点

- 1試合につき2行のデータが必要（各プレイヤー1行ずつ）
- 通常試合：17枚を先に取った方が勝利（合計17枚）
- 同枚数試合：同枚数で並んだ場合、残り札で勝負（獲得札数には含めない）
- お手つき等：ルール違反により合計17枚未満で終了する場合もあり
- 最高獲得枚数は17枚、最低0枚
- 結果は「勝」「負」で記録（引き分けは存在しない）
- **ブランク行**: 試合番号以外の列がブランクの行は自動的にスキップされます

## 出力

プログラムは以下の2つのシートを含むExcelファイルを出力します：

1. **レーティング**: 最終的な各プレイヤーのレーティング（降順）
2. **試合履歴**: 各試合のレーティング変動履歴

## レーティングシステムについて

このシステムは改良されたEloレーティングシステムを使用し、獲得札数を考慮します：

- **初期レーティング**: 1500（調整可能）
- **K値**: 32（調整可能）
- **獲得札数の重み**: 0.3（調整可能、0.0-1.0）
- **期待勝率計算**: `1 / (1 + 10^((相手レーティング - 自分レーティング) / 400))`
- **実際スコア計算**: `(1-重み) × 勝敗スコア + 重み × 札数比率`
- **レーティング更新**: `新レーティング = 旧レーティング + K値 × (実際スコア - 期待勝率)`

### 獲得札数の考慮

- **勝敗スコア**: 勝=1.0, 負=0.0
- **札数比率**: 獲得札数 / 総札数（通常17枚、同枚数時20枚）
- **同枚数処理**: 同枚数の場合は札数の影響を除外し、勝敗のみで評価
- **重み調整**: `-w`オプションで札数の影響度を調整可能
  - 0.0: 勝敗のみ（従来のElo）
  - 1.0: 札数のみ（同枚数では無効）
  - 0.3: バランス型（推奨）

## サンプルデータ

`sample_data.xlsx`にサンプルデータが含まれています。

## ライセンス

MIT License
